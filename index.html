<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Test Http Request From JS</title>
    <link href="asciidoctor/asciidoctor.css" rel="stylesheet" />
</head>
<body onload="init()">
<p>
    <input type="button" value="Test Requests" onclick="test_request()" />
</p>
<h1>Render a Rule</h1>
<select onchange="renderRule(this.value)">
    <option value="">--Please choose a rule--</option>
    <option value="S3457/c-family">S3457/c-family</option>
    <option value="S3457/java">S3457/java</option>
    <option value="S3457/python">S3457/python</option>
</select><br />
<br />
<div id="div-result"></div>
</body>
<script src="asciidoctor/asciidoctor.js"></script>
<script>
    function renderRule(/*string*/ruleId) {
      if (ruleId === "") {
        document.getElementById("div-result").innerHTML = "";
        return;
      }
      const asciiDoctor = Asciidoctor();
      const rulesDir = parentDirectory(location.href) + "rules";
      const ruleFile = rulesDir + "/" + ruleId + "/rule.adoc";
      httpGet(ruleFile, function(body) {
        const baseDir = parentDirectory(ruleFile);
        const opts = {safe: 'safe', base_dir: baseDir, attributes: { } };
        document.getElementById("div-result").innerHTML = asciiDoctor.convert(body, opts);
      });
    }

    function httpGet(/*string*/url, /*function*/bodyConsumer) /*void*/ {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.setRequestHeader("Accept", "*");
      xhr.onreadystatechange = function() {
        if(xhr.readyState === 4) {
          if (xhr.status === 200) {
            bodyConsumer(xhr.responseText);
          } else {
            console.error("ERROR " + xhr.status + " while loading " + url);
          }
        }
      }
      xhr.send();
    }

    function init() {

    }

    function test_request() {
      const asciiDoctor = Asciidoctor();
      const github_v3 ="application/vnd.github.v3.html";
      const divResult = document.getElementById("div-result");
      divResult.innerHTML = "";
      const requestDataList = [
        { url: "https://sonarsource.github.io/rspec/rules/S3457/see.adoc", accept: "*", data: null },
        { url: "https://sonarsource.github.io/rspec/rules/S3457/java/rule.adoc", accept: "*", data: null },
        // { url: "https://raw.githubusercontent.com/SonarSource/rspec/master/rules/S3457/java/rule.adoc", accept: "*", data: null },
        { url: "https://raw.githubusercontent.com/SonarSource/sonar-java/master/.github/workflows/dogfood.yml", accept: "*", data: null },
        { url: "https://api.github.com/repos/SonarSource/sonar-java/branches", accept: github_v3, data: null }
      ];
      for (let i = 0; i < requestDataList.length; i++) {
        const requestData = requestDataList[i];
        try {
          const xhr = new XMLHttpRequest();
          divResult.innerText = divResult.innerText + "Call " + requestData.url + "\n";
          xhr.open('GET', requestData.url, true);
          xhr.setRequestHeader("Accept", requestData.accept);
          if (requestData.type) {
            xhr.setRequestHeader("Content-Type", requestData.type);
          }
          xhr.onreadystatechange = function() {
            let requestState =  "Request " + requestData.url + " readyState: " + xhr.readyState;
            if(xhr.readyState === 4) {
              requestState +=  " status: " + xhr.status;
              if (xhr.status === 200) {
                requestState += "\n----------------------\n" +
                  xhr.getAllResponseHeaders() +
                  "\n" +
                  xhr.responseText +
                  "\n----------------------\n";
                if (requestData.url.endsWith(".adoc")) {
                  const baseDir = parentDirectory(requestData.url);
                  const opts = {safe: 'safe', base_dir: baseDir, attributes: { } };
                  let html = asciiDoctor.convert(xhr.responseText, opts);
                  requestState += html + "\n----------------------\n";
                }
              }
            }
            divResult.innerText = divResult.innerText + requestState + "\n";
          }
          xhr.send(requestData.data);
        } catch (e) {
          let exceptionMessage = "";
          if (e.message) {
            exceptionMessage += e.message;
          }
          if (e.stack) {
            exceptionMessage += ' | stack: ' + e.stack;
          }
          divResult.innerText = divResult.innerText + "Exception while calling " + requestData.url + "\n" + exceptionMessage + "\n";
        }
      }
    }

    function parentDirectory(/*string*/path) {
      return path.replace(/\/[^/]*$/, "/");
    }
</script>
</html>
